<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCA Watchlist</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .ui {
            text-align: center;
            max-width: 600px;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            margin: auto;
            margin-top: 20px; /* Added margin at the top */
        }

        .container {
            text-align: center;
            max-width: 800px;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            overflow: auto;
            margin: auto;
            margin-top: 20px; /* Added margin at the top */
        }

        label {
            margin-right: 10px;
        }

        button {
            margin-top: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <div class="ui">
        <label for="textInput">Enter Competition ID:</label>
        <input type="text" id="textInput" placeholder="Type competition ID...">
        <button onclick="getData()">Get Data</button>
        <select id="competitionSelect" onchange="autofillCompetitionId()">
            <option value="">---Select a Competition---</option>
            <option value="cloverdaleopen2022">Cloverdale Open 2022</option>
            <option value="cubingaroundmetrotown2023">Cubing Around Metrotown 2023</option>
            <option value="vancouverfallfest2023">Vancouver Fall Fest 2023</option>
            <option value="canadasbestinthewest2024">Canada's Best in the West 2024</option>
        </select>
        <select id="competitorSelect" onchange="displayResultsForCompetitor()">
            <!-- this will be autopopulated by the page -->
        </select>
        <div id="eventsContainer"></div>
    </div>

    <div class="container">
        <div id="resultContainer"></div>
        <div id="checkboxContainer"></div>
        <button id="createWatchlistBtn" style="display: none;" onclick="createWatchlist()">Create Watchlist</button>
    </div>

    <div id="watchlistContainer" style="display: none;">
        <h2>Watchlist</h2>
        <table id="watchlistTable">
            <!-- Table content will be dynamically added here -->
        </table>
    </div>

    <script>
        // Initialize an object to store rankings
        
        const rankings = {};
        let data;
        
        function getData() {
            // Get user input
            const userInput = document.getElementById('textInput').value;

            // Make an API call to World Cube Association API
            fetch(`https://api.worldcubeassociation.org/competitions/${userInput}/wcif/public?name`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text(); // Read the response as text
                })
                .then(dataString => {
                    // Parse the string into a JavaScript object
                    data = JSON.parse(dataString);

                    // Log the entire API response (for debugging purposes)
                    console.log('API Response:', data);

                    // Display the entire API response as a string below the input
                    const resultContainer = document.getElementById('resultContainer');
                    resultContainer.textContent = JSON.stringify(data, null, 2);

                    // Call the function to format and display data
                    formatAndDisplayData(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    // Handle errors gracefully
                });
        }

        function formatAndDisplayData(data) {
            const formattedData = `
                Format Version: ${data.formatVersion}
                Competition ID: ${data.id}
                Competition Name: ${data.name}
                Start Date: ${data.schedule.startDate}
                Number of Days: ${data.schedule.numberOfDays}
                Venue: ${data.schedule.venues[0].name}
                Latitude: ${data.schedule.venues[0].latitudeMicrodegrees}
                Longitude: ${data.schedule.venues[0].longitudeMicrodegrees}
                
                --- Persons ---
                ${data.persons.map(person => {
                    // Save rankings to the 'rankings' object
                    rankings[person.wcaId] = person.personalBests.map(pBest => ({
                        //name: person.name,
                        eventId: pBest.eventId,
                        worldRanking: pBest.worldRanking,
                        //continentalRanking: pBest.continentalRanking,
                        nationalRanking: pBest.nationalRanking,
                    }));

                    // Display other details excluding rankings
                    return `
                        Name: ${person.name}
                        WCA ID: ${person.wcaId}
                        Country: ${person.countryIso2}
                        Gender: ${person.gender}
                        Assignments: ${person.assignments.map(assignment => `
                            Activity ID: ${assignment.activityId}
                            Assignment Code: ${assignment.assignmentCode}
                        `).join('\n')}
                        
                        // Exclude Personal Bests section from display
                        -----------------
                    `;
                }).join('\n')}
                
                --- Events ---
                ${data.events.map(event => `
                    Event ID: ${event.id}
                    Rounds: ${event.rounds.map(round => `
                        Round ID: ${round.id}
                        Format: ${round.format}
                        Time Limit: ${round.timeLimit}
                        Cutoff: ${round.cutoff}
                        Advancement Condition: ${round.advancementCondition}
                        Results: ${round.results.map(result => `
                            Person ID: ${result.personId}
                            Ranking: ${result.ranking}
                            Best: ${result.best}
                            Average: ${result.average}
                        `).join('\n')}
                    `).join('\n')}
                `).join('\n')}
        
        --- Schedule ---
        ${data.schedule.venues[0].rooms[0].activities.map(activity => `
            Activity ID: ${activity.id}
            Name: ${activity.name}
            Activity Code: ${activity.activityCode}
            Start Time: ${activity.startTime}
            End Time: ${activity.endTime}
        `).join('\n')}
    `;

            // Display the formatted data
            document.getElementById('resultContainer').textContent = formattedData;

            const eventsContainer = document.getElementById('eventsContainer');
            eventsContainer.innerHTML = ''; // Clear existing event buttons

            // Display event buttons dynamically
            data.events.forEach(event => {
                const button = document.createElement('button');
                button.textContent = `View Results - ${event.id}`;
                button.addEventListener('click', () => displayResultsForEvent(event, data));
                eventsContainer.appendChild(button);
            });

            // Populate the competitor dropdown dynamically
            const competitorSelect = document.getElementById('competitorSelect');
                competitorSelect.innerHTML = '<option value="main">Select Competitor</option>';
                data.persons.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.wcaId;
                    option.textContent = person.name;
                    competitorSelect.appendChild(option);
                });
            }

        function getScheduleInfo(data, activityId, activityCode) {
            const activity = data.schedule.venues[0].rooms[0].activities.find(act => act.id === activityId);
            if (activity) {
                return `Start Time: ${activity.startTime}, End Time: ${activity.endTime}`;
            }
            return 'Schedule Info Not Found';
        }
        
        function displayResultsForEvent(event, data) {
            const formattedEventData = `
                Event ID: ${event.id}
                Rounds: ${event.rounds.map(round => `
                    Round ID: ${round.id}
                    Format: ${round.format}
                    Time Limit: ${round.timeLimit}
                    Cutoff: ${round.cutoff}
                    Advancement Condition: ${round.advancementCondition}
                    Results: ${round.results.map(result => `
                        Person ID: ${result.personId}
                        Ranking: ${result.ranking}
                        Best: ${result.best}
                        Average: ${result.average}
                    `).join('\n')}
                `).join('\n')}
            `;

            // Display the formatted event data
            document.getElementById('resultContainer').textContent = formattedEventData;
        }
        
        function autofillCompetitionId() {
            const selectElement = document.getElementById('competitionSelect');
            const inputElement = document.getElementById('textInput');
            inputElement.value = selectElement.value;
        }
        
        function displayResultsForCompetitor() {
    const selectedWcaId = document.getElementById('competitorSelect').value;

    if (selectedWcaId === 'main') {
        // Display the dynamic list of checkboxes
        document.getElementById('resultContainer').textContent = ''; // Clear the result container
        displayCompetitorCheckboxes(data);
    } else {
        const competitorRankings = rankings[selectedWcaId];
        const formattedCompetitorData = `
            --- Competitor Rankings ---
            ${competitorRankings.map(ranking => `
                Event ID: ${ranking.eventId}
                World Ranking: ${ranking.worldRanking}
                National Ranking: ${ranking.nationalRanking}
            `).join('\n')}
        `;

        // Display the formatted competitor data
        document.getElementById('resultContainer').textContent = formattedCompetitorData;

        // Call the function to display assignments with the 'data' object
        displayAssignmentsForCompetitor(selectedWcaId, data);
    }
}
        
        function displayCompetitorCheckboxes(data) {
            const checkboxContainer = document.getElementById('checkboxContainer');
            checkboxContainer.innerHTML = '<h3>Select Competitors:</h3>';

            data.persons.forEach(person => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'competitorCheckbox';
                checkbox.value = person.wcaId;
                checkbox.id = person.wcaId;

                const label = document.createElement('label');
                label.htmlFor = person.wcaId;
                label.appendChild(document.createTextNode(person.name));

                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
                checkboxContainer.appendChild(document.createElement('br'));
            });

            // Attach event listener to handle checkbox changes
            checkboxContainer.addEventListener('change', handleCheckboxChange);

            // Show the "Create Watchlist" button
            const createWatchlistBtn = document.getElementById('createWatchlistBtn');
            createWatchlistBtn.style.display = 'block';
        }

        function handleCheckboxChange() {
            const checkboxes = document.getElementsByName('competitorCheckbox');
            const selectedCheckboxes = Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
    
            console.log('Selected Checkboxes:', selectedCheckboxes);
        }
    
            
        function displayAssignmentsForCompetitor(selectedWcaId, data) {
            const person = data.persons.find(person => person.wcaId === selectedWcaId);
        
            if (person) {
                const formattedAssignments = `
                    --- Competitor Assignments ---
                    ${person.assignments.map(assignment => `
                        Activity ID: ${assignment.activityId}
                        Assignment Code: ${assignment.assignmentCode}
                    `).join('\n')}
                `;
        
                // Display the formatted assignments
                document.getElementById('resultContainer').textContent += formattedAssignments;
            }
        }

        function createWatchlist() {
            const checkboxes = document.getElementsByName('competitorCheckbox');
            const selectedCheckboxes = Array.from(checkboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);
        
            // For simplicity, let's just update the content dynamically here
            const watchlistContainer = document.getElementById('watchlistContainer');
            const watchlistTable = document.getElementById('watchlistTable');
        
            // Clear existing content
            watchlistTable.innerHTML = '';
        
            // Create table header
            const headerRow = watchlistTable.insertRow(0);
        
            // Add headers for the first and second columns
            const timelineHeader = headerRow.insertCell(0);
            timelineHeader.textContent = 'Timeline';
        
            // Iterate over events and add headers for each event
            data.events.forEach(event => {
                event.rounds.forEach(round => {
                    const headerCell = headerRow.insertCell(-1);
                    headerCell.textContent = `${event.id} - ${round.id}`;
                });
            });
        
            // Add header for the third column
            const competitorHeader = headerRow.insertCell(-1);
            competitorHeader.textContent = 'Competitor';
        
            // Populate the table with data
            selectedCheckboxes.forEach(competitorId => {
                const person = data.persons.find(person => person.wcaId === competitorId);
                if (person) {
                    const row = watchlistTable.insertRow(-1);
        
                    // Add timeline information in the first column
                    const timelineCell = row.insertCell(0);
                    timelineCell.textContent = person.assignments.map(assignment => assignment.activityId).join(', ');
        
                    // Iterate over events and populate cells with names if helping out
                    data.events.forEach(event => {
                        event.rounds.forEach(round => {
                            const cell = row.insertCell(-1);
                            const helpingOut = person.assignments.some(assignment => assignment.activityId === round.id);
                            cell.textContent = helpingOut ? person.name : '';
                        });
                    });
        
                    // Add competitor name in the third column
                    const competitorCell = row.insertCell(-1);
                    competitorCell.textContent = person.name;
                }
            });
        
            // Show the watchlist container
            watchlistContainer.style.display = 'block';
        }


        
    </script>
</body>

</html>
