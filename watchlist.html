<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCA Watchlist</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
        }

        .container {
            text-align: center;
        }

        label {
            margin-right: 10px;
        }

        button {
            margin-top: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>

<body>
    <div class="container">
        <label for="textInput">Enter Competition ID:</label>
        <input type="text" id="textInput" placeholder="Type competition ID...">
        <button onclick="getData()">Get Data</button>
        <button onclick="autofillCompetitionID()">Autofill Competition ID</button>
        <div id="tableContainer"></div>
    </div>
    
        <div id="eventsContainer"></div>
        <div id="resultContainer"></div>
    </div>

    <script>
        function getData() {
            // Get user input
            const userInput = document.getElementById('textInput').value;

            // Make an API call to World Cube Association API
            fetch(`https://api.worldcubeassociation.org/competitions/${userInput}/wcif/public?name`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text(); // Read the response as text
                })
                .then(dataString => {
                    // Parse the string into a JavaScript object
                    const data = JSON.parse(dataString);

                    // Log the entire API response (for debugging purposes)
                    console.log('API Response:', data);

                    // Display the entire API response as a string below the input
                    const resultContainer = document.getElementById('resultContainer');
                    resultContainer.textContent = JSON.stringify(data, null, 2);

                    // Call the function to format and display data
                    formatAndDisplayData(data);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    // Handle errors gracefully
                });
        }

        function formatAndDisplayData(data) {
    // Initialize an object to store rankings
    const rankings = {};

    const formattedData = `
        Format Version: ${data.formatVersion}
        Competition ID: ${data.id}
        Competition Name: ${data.name}
        Start Date: ${data.schedule.startDate}
        Number of Days: ${data.schedule.numberOfDays}
        Venue: ${data.schedule.venues[0].name}
        Latitude: ${data.schedule.venues[0].latitudeMicrodegrees}
        Longitude: ${data.schedule.venues[0].longitudeMicrodegrees}
        
        --- Persons ---
        ${data.persons.map(person => {
            // Save rankings to the 'rankings' object
            rankings[person.wcaId] = person.personalBests.map(pBest => ({
                name: person.name,
                eventId: pBest.eventId,
                worldRanking: pBest.worldRanking,
                continentalRanking: pBest.continentalRanking,
                nationalRanking: pBest.nationalRanking,
            }));

            // Display other details excluding rankings
            return `
                Name: ${person.name}
                WCA ID: ${person.wcaId}
                Country: ${person.countryIso2}
                Gender: ${person.gender}
                
                // Exclude Personal Bests section from display
                -----------------
            `;
        }).join('\n')}
        
        --- Events ---
        ${data.events.map(event => `
            Event ID: ${event.id}
            Rounds: ${event.rounds.map(round => `
                Round ID: ${round.id}
                Format: ${round.format}
                Time Limit: ${round.timeLimit}
                Cutoff: ${round.cutoff}
                Advancement Condition: ${round.advancementCondition}
                Results: ${round.results.map(result => `
                    Person ID: ${result.personId}
                    Ranking: ${result.ranking}
                    Best: ${result.best}
                    Average: ${result.average}
                `).join('\n')}
            `).join('\n')}
        `).join('\n')}
        
        --- Schedule ---
        ${data.schedule.venues[0].rooms[0].activities.map(activity => `
            Activity ID: ${activity.id}
            Name: ${activity.name}
            Activity Code: ${activity.activityCode}
            Start Time: ${activity.startTime}
            End Time: ${activity.endTime}
        `).join('\n')}
    `;

            // Display the formatted data
            document.getElementById('resultContainer').textContent = formattedData;
            // Save rankings for future use
            console.log('Saved Rankings:', rankings);
            
            const eventsContainer = document.getElementById('eventsContainer');
            eventsContainer.innerHTML = ''; // Clear existing event buttons

            // Display event buttons dynamically
            data.events.forEach(event => {
                const button = document.createElement('button');
                button.textContent = `View Results - ${event.id}`;
                button.addEventListener('click', () => displayResultsForEvent(event, data));
                eventsContainer.appendChild(button);
            });
        }

        function displayResultsForEvent(event, data) {
            const formattedEventData = `
        Event ID: ${event.id}
        Rounds: ${event.rounds.map(round => `
            Round ID: ${round.id}
            Format: ${round.format}
            Time Limit: ${round.timeLimit}
            Cutoff: ${round.cutoff}
            Advancement Condition: ${round.advancementCondition}
            Results: ${round.results.map(result => `
                Person ID: ${result.personId}
                Ranking: ${result.ranking}
                Best: ${result.best}
                Average: ${result.average}
            `).join('\n')}
        `).join('\n')}
    `;

            // Display the formatted event data
            document.getElementById('resultContainer').textContent = formattedEventData;
        }
    </script>
</body>

</html>
